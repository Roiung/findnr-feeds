#!/usr/bin/lua
local ltn12 = require "luci.ltn12"
local http = require "luci.http"
local dispatcher = require "luci.dispatcher"
local sys = require "luci.sys"
local uci = require "luci.model.uci".cursor()

-- Enable caching for performance
luci.dispatcher.indexcache = "/tmp/luci-indexcache"

-- =========================================================================
-- 1. Input Processing & 2FA Check
-- =========================================================================

local env = os.getenv()
local content_len = tonumber(env.CONTENT_LENGTH) or 0
local input_data = ""

-- Read stdin if there is content (POST data)
if content_len > 0 then
    input_data = io.read(content_len) or ""
end

-- Logic: Intercept POST login
if env.REQUEST_METHOD == "POST" and content_len > 0 then
    -- Parse username
    local user = input_data:match("luci_username=([^&]+)")
    
    if user == "root" then
        -- Check if 2FA is enabled
        local enabled = uci:get("simple2fa", "global", "enabled")
        
        if enabled == "1" then
            local secret = uci:get("simple2fa", "global", "secret")
            if secret then
                -- Extract token
                local token = input_data:match("token=([^&]*)") or ""
                
                -- Verify with oathtool (base32, totp, 6 digits)
                local cmd = string.format("oathtool -b --totp -d 6 '%s'", secret)
                local correct_code = sys.exec(cmd):gsub("%s+", "")
                
                if correct_code ~= "" and token ~= correct_code then
                    -- ❌ Verification Failed
                    print("Status: 302 Found")
                    print("Location: " .. (env.SCRIPT_NAME or "/cgi-bin/luci") .. "?simple2fa_err=1")
                    print("")
                    os.exit(0)
                end
                
                -- ✅ Success: Allow request to proceed to real dispatcher
            end
        end
    end
end

-- =========================================================================
-- 2. Dispatch to Real LuCI
-- =========================================================================

-- We no longer need to check for GET or inject HTML.
-- The modified 'sysauth.js' view handles the UI.
-- We just pass the request through.

local req = http.Request(
    env,
    ltn12.source.string(input_data),
    ltn12.sink.file(io.stdout)
)

dispatcher.http_dispatch(req)