#!/usr/bin/lua
--[[
  Simple2FA Debug Build - CGI Script
  所有操作都会记录到系统日志，使用 logread | grep simple2fa 查看
  标记: Simple2FA-Debug (用于识别是否已替换)
]]--

-- 日志函数
local function log(msg)
    os.execute(string.format("logger -t simple2fa '[CGI] %s'", msg:gsub("'", "\\'")))
end

log("========== CGI 被调用 ==========")

-- 获取环境变量
local method = os.getenv("REQUEST_METHOD") or "UNKNOWN"
local content_len = tonumber(os.getenv("CONTENT_LENGTH")) or 0
local uri = os.getenv("REQUEST_URI") or "UNKNOWN"

log(string.format("请求信息: METHOD=%s, CONTENT_LENGTH=%d, URI=%s", method, content_len, uri))

-- 读取 POST 数据 (如果有)
local post_data = ""
if method == "POST" and content_len > 0 and content_len < 10240 then
    post_data = io.read(content_len) or ""
    log(string.format("POST 数据长度: %d 字节", #post_data))
    
    -- 解析关键字段 (不记录密码)
    local username = post_data:match("luci_username=([^&]+)")
    local has_password = post_data:match("luci_password=") and true or false
    local totp_code = post_data:match("totp_code=([^&]*)") or ""
    
    log(string.format("表单解析: username=%s, has_password=%s, totp_code='%s'", 
        username or "nil", tostring(has_password), totp_code))
    
    -- 检查是否需要 2FA 验证
    if username == "root" then
        log("用户 root 登录检测 -> 检查 2FA 配置")
        
        -- 读取 UCI 配置
        local handle = io.popen("uci -q get simple2fa.global.enabled")
        local enabled = handle:read("*a"):gsub("%s+", "")
        handle:close()
        log(string.format("UCI 读取: enabled='%s'", enabled))
        
        if enabled == "1" then
            log("2FA 已启用 -> 开始验证")
            
            -- 获取密钥
            handle = io.popen("uci -q get simple2fa.global.secret")
            local secret = handle:read("*a"):gsub("%s+", "")
            handle:close()
            
            if secret and #secret > 0 then
                log(string.format("密钥已配置 (长度=%d)", #secret))
                
                -- 调用 oathtool 计算正确验证码
                local cmd = string.format("oathtool -b --totp -d 6 '%s' 2>&1", secret)
                handle = io.popen(cmd)
                local correct_code = handle:read("*a"):gsub("%s+", "")
                handle:close()
                
                log(string.format("TOTP 计算: correct='%s', input='%s'", correct_code, totp_code))
                
                if correct_code ~= "" and totp_code ~= correct_code then
                    log("❌ 验证失败 -> 重定向到登录页")
                    print("Status: 302 Found")
                    print("Location: /cgi-bin/luci?simple2fa_err=1")
                    print("")
                    os.exit(0)
                else
                    log("✅ 验证成功 (或验证码匹配)")
                end
            else
                log("警告: 密钥未配置，跳过验证")
            end
        else
            log("2FA 未启用，跳过验证")
        end
    end
end

log("继续执行原始 LuCI 流程...")

-- 调用原始 LuCI
require "luci.cacheloader"
require "luci.sgi.cgi"

-- 如果我们读取了 POST 数据，需要"喂回"给 LuCI
-- 通过设置环境变量和重定向 stdin
if #post_data > 0 then
    -- 创建临时文件存储 POST 数据
    local tmp_file = "/tmp/simple2fa_post_" .. os.time()
    local f = io.open(tmp_file, "w")
    if f then
        f:write(post_data)
        f:close()
        
        -- 重新打开作为 stdin
        io.input(tmp_file)
        log("POST 数据已存储到临时文件并重定向 stdin")
    end
end

luci.dispatcher.indexcache = "/tmp/luci-indexcache"
log("调用 luci.sgi.cgi.run()")

local ok, err = pcall(function()
    luci.sgi.cgi.run()
end)

if not ok then
    log(string.format("LuCI 执行错误: %s", tostring(err)))
end

log("========== CGI 结束 ==========")